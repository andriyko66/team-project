<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Лабораторна робота</title>

  <style>
    body { margin: 0; font-family: Arial; background: #f4f4f4; }
    header { background: #222; color: white; padding: 15px; text-align: center; }
    nav { background: #333; display: flex; justify-content: center; }
    nav button {
      background: none;
      border: none;
      color: white;
      padding: 15px 20px;
      cursor: pointer;
    }
    nav button:hover { background: #555; }
    main { padding: 20px; }
    .page { display: none; }
    .page.active { display: block; }
    .card {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 6px;
    }
    .btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
    }
    .danger { background: #dc3545; }
    .banner {
      background: orange;
      padding: 10px;
      text-align: center;
      font-weight: bold;
    }
  </style>
</head>

<body>

<header>
  <h1>Навчальний Web-додаток</h1>
</header>

<nav>
  <button onclick="showPage('home')">Головна</button>
  <button onclick="showPage('items')">Товари</button>
  <button onclick="showPage('orders')">Замовлення</button>
  <button onclick="showPage('health')">Статус сервера</button>
</nav>

<div id="degraded"></div>

<main>
  <div id="home" class="page active">
    <div class="card">
      <h2>Вітаю</h2>
      <p>Лабораторна робота з REST, ідемпотентністю та fault tolerance.</p>
    </div>
  </div>

  <div id="items" class="page">
    <h2>Товари</h2>
    <div id="itemsList"></div>
  </div>

  <div id="orders" class="page">
    <h2>Замовлення</h2>
    <button class="btn" onclick="loadOrders()">Оновити</button>
    <div id="ordersList"></div>
  </div>

  <div id="health" class="page">
    <h2>Статус сервера</h2>
    <button class="btn" onclick="checkHealth()">Перевірити</button>
    <pre id="healthResult"></pre>
  </div>
</main>

<script>
const API_URL = "http://localhost:3000";
let errorStreak = 0;

/* NAVIGATION */
function showPage(id) {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById(id).classList.add("active");

  if (id === "items") loadItems();
  if (id === "orders") loadOrders();
}

/* DEGRADED MODE */
function enableDegradedMode() {
  document.getElementById("degraded").innerHTML =
    `<div class="banner">⚠️ Degraded mode: сервер недоступний</div>`;
  document.querySelectorAll("button").forEach(b => b.disabled = true);
}

/* LOAD ITEMS */
async function loadItems() {
  const res = await fetch(`${API_URL}/items`);
  const items = await res.json();
  const box = document.getElementById("itemsList");
  box.innerHTML = "";

  items.forEach(i => {
    box.innerHTML += `
      <div class="card">
        <b>${i.name}</b><br>
        ${i.description}<br>
        ${i.price} грн<br>
        <input type="number" id="q-${i.id}" value="1" min="1">
        <button class="btn" onclick="createOrder('${i.id}')">Замовити</button>
      </div>`;
  });
}

/* CREATE ORDER (IDEMPOTENT + RETRIES) */
async function createOrder(itemId) {
  if (errorStreak >= 3) return;

  const qty = Number(document.getElementById(`q-${itemId}`).value);
  const key = crypto.randomUUID();

  try {
    const controller = new AbortController();
    setTimeout(() => controller.abort(), 3000);

    const res = await fetch(`${API_URL}/orders`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Idempotency-Key": key
      },
      body: JSON.stringify({ itemId, quantity: qty }),
      signal: controller.signal
    });

    if (res.status === 429) {
      const wait = res.headers.get("Retry-After") || 3;
      setTimeout(() => createOrder(itemId), wait * 1000);
      return;
    }

    if (!res.ok) throw new Error();

    errorStreak = 0;
    alert("Замовлення створено");
    loadOrders();

  } catch {
    errorStreak++;
    if (errorStreak >= 3) enableDegradedMode();
  }
}

/* LOAD ORDERS + DELETE */
async function loadOrders() {
  const res = await fetch(`${API_URL}/orders`);
  const orders = await res.json();
  const box = document.getElementById("ordersList");
  box.innerHTML = "";

  if (!orders.length) {
    box.innerHTML = "<p>Замовлень ще немає</p>";
    return;
  }

  orders.forEach(o => {
    box.innerHTML += `
      <div class="card">
        ${o.item.name} × ${o.quantity} = ${o.total} грн<br>
        <button class="btn danger" onclick="deleteOrder('${o.id}')">Видалити</button>
      </div>`;
  });
}

async function deleteOrder(id) {
  await fetch(`${API_URL}/orders/${id}`, { method: "DELETE" });
  loadOrders();
}

/* HEALTH */
async function checkHealth() {
  const res = await fetch(`${API_URL}/health`);
  document.getElementById("healthResult").textContent =
    JSON.stringify(await res.json(), null, 2);
}
</script>

</body>
</html>
